{% extends "admin/base_site.html" %}
{% load humanize %}

{% block extrastyle %}
{{ block.super }}
<style>
  .page-wrap{max-width:1200px;margin:16px auto;padding:0 8px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  .header{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:800;margin:0}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .select, .btn{font-size:14px}
  .select{min-width:280px;padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;height:auto;}
  .btn{padding:8px 12px;border:1px solid #111;border-radius:10px;background:#fff;cursor:pointer}
  .btn-primary{background:#111827;color:#fff;border-color:#111827}
  .btn-danger{background:#fff;color:#b91c1c;border-color:#b91c1c}
  .btn-outline{background:#fff}
  .count {margin-right:auto;color:#6b7280}
  .table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;background:#f3f4f6;padding:10px;border-bottom:1px solid #e5e7eb;
    font-weight:700;text-align:center
  }
  td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:center;vertical-align:middle}
  tbody tr:nth-child(odd){background:#fafafa}
  .muted{color:#9ca3af}

  /* ---------- چاپ ---------- */
  @media print{
    @page { size: A4 portrait; margin: 4mm; }

    html, body{
      margin:0 !important; padding:0 !important; background:#fff !important;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    #header, #user-tools, #nav-sidebar, .breadcrumbs, aside, nav, .no-print{ display:none !important; }
    #content > h1, #content h1{ display:none !important; }

    #content, .container, .page-wrap{ max-width:none !important; margin:0 !important; padding:0 !important; }

    #print-area{ width:100% !important; margin:0 !important; padding:0 !important; }
    .table-wrap{ overflow:visible !important; border:none !important; border-radius:0 !important; }

    .print-only{ display:block !important; }
    .print-header{ margin:0 0 4mm 0; text-align:center; direction:rtl; }
    .print-header h2{ margin:0; font-weight:800; font-size:14pt; }

    table{ width:100% !important; table-layout:fixed; border-collapse:collapse; font-size:11pt; direction:rtl; }
    thead{ display:table-header-group; }
    thead th{
      position:static !important;
      background:#f3f4f6 !important; border:1px solid #ddd !important; padding:6pt !important;
      text-align:center; font-weight:700;
    }
    tbody td{
      border:1px solid #ddd !important; padding:6pt !important; text-align:center; vertical-align:middle;
      word-wrap:break-word; font-size:11px; font-weight:800;
    }
    tbody tr{ page-break-inside:avoid; }
    tbody tr:nth-child(odd){ background:transparent !important; }
  }

  .print-only{ display:none; }
</style>
{% endblock %}

{% block content %}
<div class="page-wrap" dir="rtl">

  <div class="card no-print">
    <div class="header">
      <div class="controls">
        <label for="seminar" style="font-weight:700">سمینار:</label>

        <!-- فرم: همیشه به ویوی سفارشی برو -->
        <form method="get"
              action="{% url 'admin:competitions_seminar_participants' %}"
              id="filter-form"
              style="display:flex;gap:8px;align-items:center">
          <select name="seminar" id="seminar" class="select">
            <option value="">— انتخاب کنید —</option>
            {% for s in seminars %}
              <option value="{{ s.id }}"
                {% if selected and s.id == selected.id %}selected{% elif selected_id and s.id == selected_id %}selected{% endif %}>
                {{ s.title }}
              </option>
            {% endfor %}
          </select>
          <button class="btn btn-primary" type="submit">نمایش</button>
          <a href="{% url 'admin:competitions_seminar_participants' %}" class="btn btn-danger" type="button">پاک‌سازی</a>
          <button class="btn btn-outline" type="button" onclick="window.print()">چاپ جدول</button>
        </form>
      </div>

      <div class="count">
        {% if selected %}
          {{ selected.title }} — {{ rows|length|intcomma }} نفر
        {% elif selected_seminar %}
          {{ selected_seminar.title }} — {{ registrations|length|intcomma }} نفر
        {% endif %}
      </div>
    </div>
  </div>

  <div id="print-area" class="table-wrap" style="margin-top:12px">
    <div class="print-header print-only">
      {% if selected %}
        <h2>{{ selected.title }}</h2>
      {% elif selected_seminar %}
        <h2>{{ selected_seminar.title }}</h2>
      {% else %}
        <h2>لیست شرکت‌کنندگان سمینارها</h2>
      {% endif %}
    </div>

    <table aria-label="جدول شرکت‌کنندگان">
      <thead>
        <tr>
          <th style="width:70px">#</th>
          <th>نام و نام خانوادگی</th>
          <th>کد ملی</th>
          <th>درجه کمربند</th>
          <th>نقش/نقش‌ها</th>
          <th>موبایل</th>
          <th>پرداخت</th>
          <th>مبلغ (تومان)</th>
        </tr>
      </thead>
      <tbody>
        {% if rows %}
          {% for r in rows %}
            <tr>
              <td>{{ r.idx }}</td>
              <td>{{ r.full_name }}</td>
              <td>{{ r.nid }}</td>
              <td>{{ r.belt }}</td>
              <td>{{ r.roles_fa }}</td>
              <td>{{ r.mobile }}</td>
              <td>{{ r.paid }}</td>
              <td>{{ r.amount|intcomma }}</td>
            </tr>
          {% endfor %}
        {% elif registrations %}
          {% for r in registrations %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ r.user.get_full_name|default:r.user.username }}</td>
              <td>{{ r.user.profile.national_code|default:"—" }}</td>
              <td>{{ r.user.profile.belt_grade|default:"—" }}</td>
              <td>
                {% if r.roles %}
                  {% for x in r.roles %}{{ x }}{% if not forloop.last %}، {% endif %}{% endfor %}
                {% else %}—{% endif %}
              </td>
              <td>{% if r.phone %}{{ r.phone }}{% elif r.user.profile and r.user.profile.phone %}{{ r.user.profile.phone }}{% else %}—{% endif %}</td>
              <td>{% if r.is_paid %}بله{% else %}خیر{% endif %}</td>
              <td>{{ r.paid_amount|default:0|intcomma }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="muted">ابتدا سمینار را انتخاب کرده و روی «نمایش» بزنید.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
